<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Cotizaci√≥n | Home Support Electric</title>
  <!-- jsPDF y SheetJS desde CDN seguros -->
  <script src="https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #1e40af;
      --primary-light: #3b82f6;
      --primary-dark: #1d4ed8;
      --gray-50: #f8fafc;
      --gray-100: #f1f5f9;
      --gray-200: #e2e8f0;
      --gray-300: #cbd5e1;
      --gray-600: #475569;
      --gray-700: #334155;
      --gray-800: #1e293b;
      --danger: #ef4444;
      --success: #10b981;
      --space-xs: 0.25rem;
      --space-sm: 0.5rem;
      --space-md: 1rem;
      --space-lg: 1.5rem;
      --font-sans: "Inter", system-ui, sans-serif;
      --shadow: 0 2px 6px rgba(0,0,0,0.08);
      --transition: all 0.2s ease;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: var(--font-sans);
      background-color: #f9fafb;
      color: var(--gray-800);
      line-height: 1.5;
      padding: 12px;
      font-size: 15px;
    }

    .container {
      max-width: 100%;
      background: white;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: var(--shadow);
    }

    /* Encabezado */
    .header {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      padding: 16px;
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
      text-align: center;
    }
    .logo {
      width: 80px;
      height: 80px;
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      background: white;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .logo img { width: 56px; height: 56px; object-fit: contain; }
    .header h1 { font-size: 1.4rem; font-weight: 700; }
    .header p { font-size: 0.95rem; opacity: 0.95; }

    /* Secci√≥n */
    .section {
      padding: 16px;
      border-bottom: 1px solid var(--gray-200);
    }
    .section-title {
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 14px;
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .section-title::before {
      content: ""; width: 4px; height: 18px; background: var(--primary); border-radius: 2px;
    }

    /* Empresa / Cliente */
    .info-card {
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: 12px;
      padding: 16px;
      box-shadow: var(--shadow);
    }
    .field-row {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-bottom: 12px;
    }
    .field-label {
      font-weight: 600;
      color: var(--gray-700);
      font-size: 0.875rem;
    }
    .field-value {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--gray-300);
      border-radius: 10px;
      font: inherit;
      font-size: 1rem;
      background: white;
    }
    .field-value:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
    }
    .field-web {
      color: var(--primary);
      text-decoration: underline;
    }

    /* Productos */
    .table-container {
      overflow-x: auto;
      padding: 0 16px 16px;
    }
    table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
    thead th {
      background: var(--primary);
      color: white;
      font-weight: 600;
      padding: 10px 8px;
      text-align: left;
    }
    tbody tr { border-bottom: 1px solid var(--gray-200); }
    tbody td { padding: 12px 8px; vertical-align: top; }
    .input-cell {
      width: 100%;
      padding: 8px;
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      font: inherit;
    }
    .desc-cell textarea {
      width: 100%;
      min-height: 60px;
      padding: 8px;
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      font: inherit;
      resize: vertical;
    }
    .action-cell {
      text-align: center;
      padding: 8px !important;
    }
    .btn-icon {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      border: none;
      background: var(--gray-200);
      color: var(--gray-700);
      cursor: pointer;
      font-weight: bold;
    }
    .btn-icon:hover {
      background: var(--danger);
      color: white;
    }

    /* Notas */
    .notes-section {
      padding: 0 16px 16px;
    }
    .combo-notes select {
      width: 100%;
      padding: 14px 40px 14px 14px;
      border: 1px solid var(--gray-300);
      border-radius: 10px;
      font: inherit;
      font-size: 1rem;
      background: white url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%236b7280'%3E%3Cpath d='M7.247 11.14L2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 01.753 1.659l-4.796 5.48a1 1 0 01-1.506 0z'/%3E%3C/svg%3E") no-repeat right 12px center;
    }
    .notes-section textarea {
      width: 100%;
      min-height: 140px;
      padding: 14px;
      border: 1px solid var(--gray-300);
      border-radius: 10px;
      font: inherit;
      font-size: 0.95rem;
    }

    /* Totales */
    .totals-bar {
      position: sticky;
      bottom: 0;
      background: white;
      padding: 14px 16px;
      border-top: 2px solid var(--gray-200);
      box-shadow: 0 -4px 12px rgba(0,0,0,0.05);
      z-index: 10;
    }
    .totals-row {
      display: flex;
      justify-content: space-between;
      font-weight: 600;
      margin-bottom: 6px;
      font-size: 0.95rem;
    }
    .totals-row.total {
      font-size: 1.2rem;
      color: var(--primary-dark);
      margin-top: 6px;
      padding-top: 8px;
      border-top: 1px solid var(--gray-200);
    }

    /* Botones de acci√≥n */
    .action-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      padding: 16px;
      background: var(--gray-50);
    }
    .btn {
      flex: 1;
      min-width: 130px;
      padding: 14px;
      border: none;
      border-radius: 12px;
      font-weight: 600;
      font-size: 0.92rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      box-shadow: var(--shadow);
    }
    .btn-print { background: #6b7280; color: white; }
    .btn-excel { background: #10b981; color: white; }
    .btn-share { background: #0d9488; color: white; }
    .btn-add { background: var(--primary); color: white; }

    /* Footer */
    .footer {
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .date-field {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .date-field input {
      padding: 12px;
      border: 1px solid var(--gray-300);
      border-radius: 10px;
      font: inherit;
    }
    .signature {
      text-align: center;
      padding-top: 12px;
      border-top: 1px solid var(--gray-200);
    }

    .icon { width: 18px; height: 18px; stroke: currentColor; stroke-width: 2; }
    
    /* Imprimir */
    @media print {
      body { padding: 0; background: white; }
      .container { border-radius: 0; box-shadow: none; }
      .action-bar, .btn-add { display: none !important; }
      .field-value, .desc-cell textarea { border: none; background: none; }
      a { color: var(--primary) !important; text-decoration: underline !important; }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Encabezado -->
    <header class="header">
      <div class="logo">
        <img src="https://github.com/aldacom1986/HSE/blob/main/hselogoredondo.png?raw=true" alt="Home Support Electric" id="logo-img">
      </div>
      <h1>Home Support Electric</h1>
      <p>Materiales El√©ctricos Residenciales y Comerciales</p>
    </header>

    <!-- EMPRESA -->
    <section class="section">
      <h2 class="section-title">INFORMACI√ìN DE LA EMPRESA</h2>
      <div class="info-card">
        <div class="field-row">
          <label class="field-label">RFC:</label>
          <input type="text" id="emp-rfc" class="field-value" value="RUCJ810917N71" readonly>
        </div>
        <div class="field-row">
          <label class="field-label">Nombre:</label>
          <input type="text" id="emp-nombre" class="field-value" value="Home Support Electric" readonly>
        </div>
        <div class="field-row">
          <label class="field-label">Direcci√≥n:</label>
          <input type="text" id="emp-direccion" class="field-value" value="Vista a la Catedral 3001, Col. Mirador, CP. 45608" readonly>
        </div>
        <div class="field-row">
          <label class="field-label">Tel√©fono y WhatsApp:</label>
          <input type="tel" id="emp-tel" class="field-value" value="33 1295 8108" readonly>
        </div>
        <div class="field-row">
          <label class="field-label">Sitio web:</label>
          <a href="http://www.homesupportelectric.com" target="_blank" class="field-value field-web">www.homesupportelectric.com</a>
        </div>
      </div>
    </section>

    <!-- CLIENTE -->
    <section class="section">
      <h2 class="section-title">INFORMACI√ìN DEL CLIENTE</h2>
      <div class="info-card">
        <div class="field-row">
          <label class="field-label">CLIENTE:</label>
          <input type="text" id="cli-nombre" class="field-value" placeholder="[Nombre del Cliente]">
        </div>
        <div class="field-row">
          <label class="field-label">CONTACTO:</label>
          <input type="text" id="cli-contacto" class="field-value" placeholder="[Persona de Contacto]">
        </div>
        <div class="field-row">
          <label class="field-label">TEL√âFONO:</label>
          <input type="tel" id="cli-tel" class="field-value" placeholder="[N√∫mero de Tel√©fono]">
        </div>
        <div class="field-row">
          <label class="field-label">CORREO:</label>
          <input type="email" id="cli-email" class="field-value" placeholder="[Email del Cliente]">
        </div>
      </div>
    </section>

    <!-- Productos -->
    <section class="section">
      <h2 class="section-title">PRODUCTOS/SERVICIOS</h2>
      <div class="table-container">
        <table id="productos">
          <thead>
            <tr>
              <th>√çTEM</th>
              <th>CANT</th>
              <th>UNID</th>
              <th>DESCRIPCI√ìN</th>
              <th>P. UNIT</th>
              <th>IMPORTE</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="productos-body"></tbody>
        </table>
        <button class="btn btn-add" style="width:100%; margin-top:12px;" onclick="agregarFila()">
          ‚ûï Agregar Producto
        </button>
      </div>
    </section>

    <!-- Notas -->
    <section class="notes-section">
      <h2 class="section-title">NOTAS Y CONDICIONES</h2>
      <div class="combo-notes">
        <select id="notas-combo" onchange="aplicarNotaPredefinida(this.value)">
          <option value="">‚Äî Seleccione ‚Äî</option>
          <option value="default" selected>‚úîÔ∏è Condiciones Est√°ndar HSE</option>
          <option value="credito">üí≥ Cr√©dito 20 d√≠as</option>
          <option value="anticipo">üí∞ 50% anticipo</option>
        </select>
      </div>
      <textarea id="notas" placeholder="Notas personalizadas..."></textarea>
    </section>

    <!-- Totales -->
    <div class="totals-bar">
      <div class="totals-row">
        <span>SUBTOTAL:</span>
        <span id="subtotal">$0.00</span>
      </div>
      <div class="totals-row">
        <span>IVA (16%):</span>
        <span id="iva">$0.00</span>
      </div>
      <div class="totals-row total">
        <span>TOTAL:</span>
        <span id="total">$0.00</span>
      </div>
    </div>

    <!-- Botones: Imprimir/PDF, Excel, Compartir -->
    <div class="action-bar">
      <button class="btn btn-print" onclick="imprimirOGenerarPDF()">
        <svg class="icon" viewBox="0 0 24 24"><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h2V6a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v3h2a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><path d="M6 9H4a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h2"/><path d="M18 9h2a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><path d="M6 14h12"/></svg>
        Imprimir / PDF
      </button>
      <button class="btn btn-excel" onclick="exportarExcel()">
        <svg class="icon" viewBox="0 0 24 24"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/></svg>
        Excel
      </button>
      <button class="btn btn-share" onclick="mostrarCompartir()">
        <svg class="icon" viewBox="0 0 24 24"><path d="M18 8a6 6 0 0 1 0 12 5 5 0 0 1-4.24-2H6a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h8.24A5 5 0 0 1 18 8z"/><circle cx="12" cy="10" r="2"/></svg>
        Compartir
      </button>
    </div>

    <!-- Footer -->
    <footer class="footer">
      <div class="date-field">
        <label class="field-label">Fecha de Emisi√≥n</label>
        <input type="date" id="fecha-emision">
      </div>
      <div class="date-field">
        <label class="field-label">V√°lido hasta</label>
        <input type="date" id="fecha-vencimiento">
      </div>
      <div class="signature">
        <p>Gerente de Ventas</p>
        <p><strong>Home Support Electric</strong></p>
      </div>
    </footer>
  </div>

  <!-- Modal Compartir -->
  <div id="modal-compartir" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center;">
    <div style="background:white; border-radius:16px; width:90%; max-width:400px; padding:24px; text-align:center;">
      <h3 style="font-weight:700; color:var(--gray-800); margin-bottom:20px;">Compartir Cotizaci√≥n</h3>
      <div style="display:flex; flex-direction:column; gap:12px;">
        <button class="btn" style="background:#25D366; color:white;" onclick="compartirWhatsApp()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white"><path d="M18 8a6 6 0 0 1 0 12 5 5 0 0 1-4.24-2H6a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h8.24A5 5 0 0 1 18 8z"/><circle cx="12" cy="10" r="2"/></svg>
          WhatsApp
        </button>
        <button class="btn" style="background:#3b82f6; color:white;" onclick="compartirEmail()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><path d="M22 6l-10 7L2 6"/></svg>
          Email
        </button>
      </div>
      <button style="margin-top:20px; background:var(--gray-200); color:var(--gray-700); border-radius:10px; border:none; padding:10px 20px;" onclick="cerrarCompartir()">Cancelar</button>
    </div>
  </div>

  <script>
    // Acceso a jsPDF
    const { jsPDF } = window.jspdf;

    const NOTAS_DEFAULT = `‚Ä¢ Los precios son en pesos mexicanos, sujetos a cambio sin previo aviso.
‚Ä¢ Los tiempos de entrega son salvo previa venta; en caso de que al recibir su orden ya no se tenga el material, se le informar√° de inmediato.
‚Ä¢ Los precios son L.A.B. en Guadalajara.
‚Ä¢ La fecha de entrega es la correspondiente en cada descripci√≥n.
‚Ä¢ Se requiere el 50% de anticipo y 50% contra aviso de disponibilidad.
‚Ä¢ Depositar el anticipo a nombre de Jos√© de Jes√∫s Rubio Castro a la cuenta de BBVA 012320001643356192.
‚Ä¢ Condiciones de cr√©dito: 20 d√≠as.`;

    // Fechas
    const hoy = new Date();
    const hoyStr = hoy.toISOString().slice(0,10);
    const vto = new Date();
    vto.setDate(hoy.getDate() + 30);
    const vtoStr = vto.toISOString().slice(0,10);
    document.getElementById('fecha-emision').value = hoyStr;
    document.getElementById('fecha-vencimiento').value = vtoStr;

    // Inicializar
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('notas').value = NOTAS_DEFAULT;
      agregarFila();
    });

    // Productos
    let contador = 1;
    function agregarFila() {
      const tbody = document.getElementById('productos-body');
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td style="font-weight:600">${contador}</td>
        <td><input type="number" min="0" value="1" class="input-cell" oninput="calcularFila(this)" style="width:70px"></td>
        <td><input type="text" placeholder="pza" class="input-cell" style="width:60px" oninput="guardarCache()"></td>
        <td class="desc-cell"><textarea placeholder="Descripci√≥n..." oninput="guardarCache()"></textarea></td>
        <td><input type="number" min="0" step="0.01" value="0.00" class="input-cell" oninput="calcularFila(this)" style="width:80px"></td>
        <td style="font-weight:600; color:#1e40af">$0.00</td>
        <td class="action-cell">
          <button class="btn-icon" onclick="eliminarFila(this)">üóëÔ∏è</button>
        </td>
      `;
      tbody.appendChild(tr);
      contador++;
      guardarCache();
    }

    function eliminarFila(btn) {
      const tr = btn.closest('tr');
      tr.remove();
      renumerar();
      calcularTotales();
      guardarCache();
    }

    function renumerar() {
      const filas = document.querySelectorAll('#productos-body tr');
      filas.forEach((tr, i) => tr.cells[0].textContent = i + 1);
      contador = filas.length + 1;
    }

    function calcularFila(input) {
      const tr = input.closest('tr');
      const cant = parseFloat(tr.cells[1].querySelector('input').value) || 0;
      const precio = parseFloat(tr.cells[4].querySelector('input').value) || 0;
      const importe = cant * precio;
      tr.cells[5].textContent = '$' + importe.toFixed(2);
      calcularTotales();
      guardarCache();
    }

    function calcularTotales() {
      let subtotal = 0;
      document.querySelectorAll('#productos-body tr').forEach(tr => {
        const txt = tr.cells[5].textContent.replace('$', '');
        subtotal += parseFloat(txt) || 0;
      });
      const iva = subtotal * 0.16;
      const total = subtotal + iva;
      document.getElementById('subtotal').textContent = '$' + subtotal.toFixed(2);
      document.getElementById('iva').textContent = '$' + iva.toFixed(2);
      document.getElementById('total').textContent = '$' + total.toFixed(2);
    }

    function aplicarNotaPredefinida(key) {
      if (key === 'default') {
        document.getElementById('notas').value = NOTAS_DEFAULT;
      } else if (key === 'credito') {
        document.getElementById('notas').value = `‚Ä¢ Condiciones de cr√©dito: 20 d√≠as naturales desde la fecha de factura.\n‚Ä¢ Requiere aprobaci√≥n crediticia previa.\n‚Ä¢ Documentos: copia de RFC, acta constitutiva y estado de cuenta bancario.`;
      } else if (key === 'anticipo') {
        document.getElementById('notas').value = `‚Ä¢ Se requiere el 50% de anticipo para liberar pedido.\n‚Ä¢ El 50% restante se paga contra aviso de disponibilidad.\n‚Ä¢ Datos bancarios: BBVA ‚Ä¢ Jos√© de Jes√∫s Rubio Castro ‚Ä¢ Cuenta: 012320001643356192`;
      }
      guardarCache();
    }

    function guardarCache() {
      const data = {
        cliente: {
          nombre: document.getElementById('cli-nombre').value,
          contacto: document.getElementById('cli-contacto').value,
          tel: document.getElementById('cli-tel').value,
          email: document.getElementById('cli-email').value
        },
        notas: document.getElementById('notas').value,
        fechaEmision: document.getElementById('fecha-emision').value,
        fechaVencimiento: document.getElementById('fecha-vencimiento').value,
        filas: []
      };

      document.querySelectorAll('#productos-body tr').forEach(tr => {
        const inps = tr.querySelectorAll('input, textarea');
        data.filas.push({
          cantidad: inps[0].value,
          unidad: inps[1].value,
          descripcion: inps[2].value,
          precio: inps[3].value
        });
      });

      localStorage.setItem('hse_cotizacion_final', JSON.stringify(data));
    }

    // Cargar al iniciar
    document.addEventListener('DOMContentLoaded', () => {
      const saved = localStorage.getItem('hse_cotizacion_final');
      if (saved) {
        const d = JSON.parse(saved);
        document.getElementById('cli-nombre').value = d.cliente?.nombre || '';
        document.getElementById('cli-contacto').value = d.cliente?.contacto || '';
        document.getElementById('cli-tel').value = d.cliente?.tel || '';
        document.getElementById('cli-email').value = d.cliente?.email || '';
        document.getElementById('notas').value = d.notas || NOTAS_DEFAULT;
        document.getElementById('fecha-emision').value = d.fechaEmision || hoyStr;
        document.getElementById('fecha-vencimiento').value = d.fechaVencimiento || vtoStr;

        const tbody = document.getElementById('productos-body');
        tbody.innerHTML = '';
        contador = 1;
        d.filas?.forEach(f => {
          agregarFila();
          const rows = document.querySelectorAll('#productos-body tr');
          const last = rows[rows.length - 1];
          const inps = last.querySelectorAll('input, textarea');
          inps[0].value = f.cantidad;
          inps[1].value = f.unidad;
          inps[2].value = f.descripcion;
          inps[3].value = f.precio;
          calcularFila(inps[3]);
        });
      }
    });

    document.querySelectorAll('input, textarea, select').forEach(el => {
      el.addEventListener('input', guardarCache);
    });

    // ‚úÖ ‚úÖ ‚úÖ IMPRIMIR / PDF FUNCIONAL (CORREGIDO)
    function imprimirOGenerarPDF() {
      const cliNombre = document.getElementById('cli-nombre').value || 'Cliente';
      if (!cliNombre.trim()) {
        alert("‚ö†Ô∏è Por favor ingresa el nombre del cliente.");
        return;
      }

      // Opci√≥n: imprimir directo (r√°pido en celulares)
      if (window.confirm("¬øDeseas imprimir directamente?\n\n(cancelar para generar PDF descargable)")) {
        window.print();
        return;
      }

      // ‚úÖ Generar PDF con jsPDF (versi√≥n segura)
      try {
        const doc = new jsPDF({
          orientation: 'portrait',
          unit: 'mm',
          format: 'a4'
        });

        const pageWidth = doc.internal.pageSize.width;
        const margin = 15;

        // Logo como base64 (evita CORS)
        const logoBase64 = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAYAAABw4pVUAAAABmJLR0QA/wD/AP+gvaeTAAAFGUlEQVR4nO2dW2gcVRjHf7O72aRpkzZN0jZpEqW2NlJbbW1vWG2tVbTig1gVfBARfBCkID6ID1JQEUVB8EEQK1JQ8KKI+CAo2KZpkqbZNG2a5n6JN22b3ZlzZs7snrMz5/8Dw7I7M9/5zne+75xvZg6klJIiYtG0egAUf1AIUgRQCFIEUAhSBFAIUgRQCFIEUAhSBFAIUgRQCFIEUAhSBFAIUgRQCFIEUAhSBFAIUgRQCFIEUAhSBFAIUgRQCFIEUAhSBFAIUgRQCFIEUAhSBFAIUgRQCFIEUAhSBFAIUgRQCFIEUAhSBFAIUgRQCFIEUAhSBFAIUgRQCFIEUAhSBFAIUgRQCFIEUAhSBFAIUgRQCFIE/AeJYRzUwNjJYwAAAABJRU5ErkJggg==";
        // ‚Üë Este es un placeholder blanco (evita fallos). En producci√≥n, usa tu logo real en base64.

        doc.addImage(logoBase64, 'PNG', margin, 15, 25, 25, 'SLOW');

        doc.setFontSize(18);
        doc.setTextColor(30, 64, 175);
        doc.text("Home Support Electric", pageWidth / 2, 25, { align: 'center' });

        doc.setFontSize(11);
        doc.setTextColor(100);
        doc.text("Materiales El√©ctricos Residenciales y Comerciales", pageWidth / 2, 32, { align: 'center' });

        doc.setDrawColor(226, 232, 240);
        doc.line(margin, 40, pageWidth - margin, 40);

        // Empresa
        doc.setFontSize(10);
        doc.setTextColor(0);
        doc.setFont('Inter', 'bold');
        doc.text("INFORMACI√ìN DE LA EMPRESA", margin, 50);
        doc.setFont('Inter', 'normal');
        doc.text("RFC:", margin, 57); doc.text("RUCJ810917N71", margin + 20, 57);
        doc.text("Direcci√≥n:", margin, 62); doc.text("Vista a la Catedral 3001, Col. Mirador, CP. 45608", margin + 20, 62, { maxWidth: 80 });
        doc.text("Tel/WhatsApp:", margin, 67); doc.text("33 1295 8108", margin + 20, 67);
        doc.text("Web:", margin, 72); doc.text("www.homesupportelectric.com", margin + 20, 72);

        // Cliente
        doc.setFont('Inter', 'bold');
        doc.text("INFORMACI√ìN DEL CLIENTE", pageWidth / 2 + 5, 50);
        doc.setFont('Inter', 'normal');
        doc.text("CLIENTE:", pageWidth / 2 + 5, 57); doc.text(cliNombre, pageWidth / 2 + 25, 57, { maxWidth: 70 });
        doc.text("CONTACTO:", pageWidth / 2 + 5, 62); doc.text(document.getElementById('cli-contacto').value || "", pageWidth / 2 + 25, 62, { maxWidth: 70 });
        doc.text("TEL√âFONO:", pageWidth / 2 + 5, 67); doc.text(document.getElementById('cli-tel').value || "", pageWidth / 2 + 25, 67);
        doc.text("CORREO:", pageWidth / 2 + 5, 72); doc.text(document.getElementById('cli-email').value || "", pageWidth / 2 + 25, 72, { maxWidth: 70 });

        // Productos
        let y = 85;
        doc.setFont('Inter', 'bold');
        doc.setFontSize(12);
        doc.setTextColor(30, 64, 175);
        doc.text("DETALLE DE PRODUCTOS/SERVICIOS", margin, y);
        y += 10;

        const headers = ["√çTEM", "CANT", "UNID", "DESCRIPCI√ìN", "P. UNIT", "IMPORTE"];
        const colW = [10, 15, 15, 90, 25, 25];
        doc.setFont('Inter', 'bold');
        doc.setFontSize(8);
        doc.setTextColor(255);
        doc.setFillColor(30, 64, 175);

        let x = margin;
        headers.forEach((h, i) => {
          doc.rect(x, y, colW[i], 6, 'F');
          doc.text(h, x + 2, y + 4);
          x += colW[i];
        });
        y += 6;

        doc.setFont('Inter', 'normal');
        doc.setFontSize(7);
        doc.setTextColor(0);
        const filas = document.querySelectorAll('#productos-body tr');
        filas.forEach(tr => {
          const celdas = tr.cells;
          const item = celdas[0].textContent;
          const cant = celdas[1].querySelector('input').value;
          const uni = celdas[2].querySelector('input').value;
          const desc = celdas[3].querySelector('textarea').value || "";
          const precio = celdas[4].querySelector('input').value;
          const imp = celdas[5].textContent;

          const descLines = doc.splitTextToSize(desc, 88);
          const h = Math.max(8, descLines.length * 3.5 + 3);

          doc.setDrawColor(226, 232, 240);
          doc.rect(margin, y, 180, h);
          doc.text(item, margin + 2, y + 5);
          doc.text(cant, margin + 12, y + 5);
          doc.text(uni, margin + 27, y + 5);
          doc.text(descLines, margin + 43, y + 5);
          doc.text(`$${parseFloat(precio).toFixed(2)}`, margin + 135, y + 5);
          doc.text(imp, margin + 162, y + 5);

          y += h;
          if (y > 260) {
            doc.addPage();
            y = 20;
          }
        });

        // Totales
        if (y > 245) { doc.addPage(); y = 20; }
        y += 8;
        const subtotal = document.getElementById('subtotal').textContent;
        const iva = document.getElementById('iva').textContent;
        const total = document.getElementById('total').textContent;

        doc.setFont('Inter', 'bold');
        doc.setFontSize(10);
        doc.setTextColor(30, 64, 175);
        doc.text("SUBTOTAL:", pageWidth - 50, y); doc.text(subtotal, pageWidth - 15, y, { align: 'right' }); y += 6;
        doc.text("IVA (16%):", pageWidth - 50, y); doc.text(iva, pageWidth - 15, y, { align: 'right' }); y += 6;
        doc.setFontSize(12);
        doc.text("TOTAL:", pageWidth - 50, y); doc.text(total, pageWidth - 15, y, { align: 'right' });

        // Notas
        y += 10;
        doc.setFont('Inter', 'bold');
        doc.setFontSize(10);
        doc.setTextColor(0);
        doc.text("NOTAS Y CONDICIONES:", margin, y);
        y += 6;
        doc.setFont('Inter', 'normal');
        doc.setFontSize(8);
        const notas = document.getElementById('notas').value || "";
        const lines = doc.splitTextToSize(notas, 180);
        doc.text(lines, margin, y);

        // Footer
        const fechaEmi = document.getElementById('fecha-emision').value || hoyStr;
        const fechaVto = document.getElementById('fecha-vencimiento').value || vtoStr;
        y = 275;
        doc.setFontSize(8);
        doc.text(`Fecha de Emisi√≥n: ${fechaEmi}`, margin, y);
        doc.text(`V√°lido hasta: ${fechaVto}`, pageWidth / 2, y);
        doc.setFont('Inter', 'bold');
        doc.text("Gerente de Ventas", pageWidth - 60, y - 12);
        doc.setTextColor(30, 64, 175);
        doc.text("Home Support Electric", pageWidth - 60, y);

        // ‚úÖ Descarga autom√°tica
        doc.save(`Cotizacion_HSE_${cliNombre.replace(/\s+/g, '_')}.pdf`);
      } catch (e) {
        console.error("Error generando PDF:", e);
        alert("‚ö†Ô∏è No se pudo generar el PDF. Intenta imprimir directamente o verifica tu conexi√≥n.");
      }
    }

    // ‚úÖ EXPORTAR EXCEL FUNCIONAL
    function exportarExcel() {
      const cliNombre = document.getElementById('cli-nombre').value || 'Cliente';
      if (!cliNombre.trim()) {
        alert("‚ö†Ô∏è Por favor ingresa el nombre del cliente.");
        return;
      }

      const data = [
        ["COTIZACI√ìN | Home Support Electric"],
        [],
        ["INFORMACI√ìN DE LA EMPRESA", "", "", "INFORMACI√ìN DEL CLIENTE"],
        ["RFC:", "RUCJ810917N71", "", "CLIENTE:", cliNombre],
        ["Nombre:", "Home Support Electric", "", "CONTACTO:", document.getElementById('cli-contacto').value || ""],
        ["Direcci√≥n:", "Vista a la Catedral 3001, Col. Mirador, CP. 45608", "", "TEL√âFONO:", document.getElementById('cli-tel').value || ""],
        ["Tel/WhatsApp:", "33 1295 8108", "", "CORREO:", document.getElementById('cli-email').value || ""],
        ["Web:", "www.homesupportelectric.com", "", "", ""],
        [],
        ["√çTEM", "CANTIDAD", "UNIDAD", "DESCRIPCI√ìN", "PRECIO UNITARIO", "IMPORTE"]
      ];

      document.querySelectorAll('#productos-body tr').forEach((tr, i) => {
        const inps = tr.querySelectorAll('input, textarea');
        data.push([
          i + 1,
          inps[0].value,
          inps[1].value,
          inps[2].value,
          parseFloat(inps[3].value) || 0,
          tr.cells[5].textContent.replace('$', '')
        ]);
      });

      data.push([]);
      data.push(["SUBTOTAL", "", "", "", "", document.getElementById('subtotal').textContent.replace('$', '')]);
      data.push(["IVA (16%)", "", "", "", "", document.getElementById('iva').textContent.replace('$', '')]);
      data.push(["TOTAL", "", "", "", "", document.getElementById('total').textContent.replace('$', '')]);
      data.push([]);
      data.push(["NOTAS Y CONDICIONES"]);
      data.push([document.getElementById('notas').value || ""]);
      data.push([]);
      data.push([
        "Fecha Emisi√≥n:",
        document.getElementById('fecha-emision').value || hoyStr,
        "",
        "V√°lido hasta:",
        document.getElementById('fecha-vencimiento').value || vtoStr
      ]);
      data.push(["", "", "", "Gerente de Ventas"]);
      data.push(["", "", "", "Home Support Electric"]);

      const ws = XLSX.utils.aoa_to_sheet(data);
      ws['!cols'] = [{wch:6}, {wch:12}, {wch:12}, {wch:40}, {wch:18}, {wch:18}];
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Cotizaci√≥n");
      XLSX.writeFile(wb, `Cotizacion_HSE_${cliNombre.replace(/\s+/g, '_')}.xlsx`);
    }

    // ‚úÖ COMPARTIR
    function mostrarCompartir() {
      document.getElementById('modal-compartir').style.display = 'flex';
    }
    function cerrarCompartir() {
      document.getElementById('modal-compartir').style.display = 'none';
    }

    function compartirWhatsApp() {
      const nombre = document.getElementById('cli-nombre').value || 'Cliente';
      const total = document.getElementById('total').textContent;
      const mensaje = `¬°Hola ${nombre}! üì©\n\nTe env√≠o la cotizaci√≥n de Home Support Electric.\n\nüìã Total: ${total}\nüìû 33 1295 8108\nüåê www.homesupportelectric.com`;
      const url = `https://wa.me/523312958108?text=${encodeURIComponent(mensaje)}`;
      window.open(url, '_blank');
      cerrarCompartir();
    }

    function compartirEmail() {
      const nombre = document.getElementById('cli-nombre').value || 'Cliente';
      const total = document.getElementById('total').textContent;
      const email = document.getElementById('cli-email').value || '';
      const asunto = `Cotizaci√≥n Home Support Electric - ${nombre}`;
      const cuerpo = `Estimado(a) ${nombre}:\n\nAdjunto encontrar√°s la cotizaci√≥n solicitada.\n\n- Total: ${total}\n- V√°lida hasta: ${document.getElementById('fecha-vencimiento').value || ''}\n\nQuedamos atentos a tus comentarios.\n\nSaludos cordiales,\nHome Support Electric\nüìû 33 1295 8108\nüåê www.homesupportelectric.com`;
      const mailto = `mailto:${email}?subject=${encodeURIComponent(asunto)}&body=${encodeURIComponent(cuerpo)}`;
      window.open(mailto, '_blank');
      cerrarCompartir();
    }
  </script>
</body>
</html>